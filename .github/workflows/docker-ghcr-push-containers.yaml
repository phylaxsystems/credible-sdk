name: Docker GHCR Push - Assertion DA

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  packages: write
  contents: read

jobs:
  get-version:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.determine-version.outputs.version }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2
      - name: Determine version tag
        id: determine-version
        run: |
          OLD_VERSION=$(git show HEAD~1:Cargo.toml 2>/dev/null | grep -m 1 '^version = ' | cut -d '"' -f2)                                                                                                           
          NEW_VERSION=$(grep -m 1 '^version = ' Cargo.toml | cut -d '"' -f2)                                                                                                                                               
                                                                                                                                                                                                                   
          if [ -n "$NEW_VERSION" ] && [ "$OLD_VERSION" != "$NEW_VERSION" ]; then                                                                                                                                           
            VERSION="$NEW_VERSION"                                                                                                                                                                                       
            echo "Version changed from $OLD_VERSION to $NEW_VERSION"                                                                                                                                                     
          else                                                                                                                                                                                                             
            VERSION=""                                                                                                                                                                                                   
            echo "Version unchanged"                                                                                                                                                                                     
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT

  docker-ghcr-push-assertion-da:
    needs: get-version
    uses: phylaxsystems/actions/.github/workflows/release-docker-ghcr.yaml@main
    with:
      rust-binary-name: assertion-da
      requires-private-deps: false
      dockerfile-path: dockerfile/Dockerfile.da
      version-tag: ${{ needs.get-version.outputs.version }}

  docker-ghcr-push-assertion-da-dev:
    needs: get-version
    uses: phylaxsystems/actions/.github/workflows/release-docker-ghcr.yaml@main
    with:
      rust-binary-name: assertion-da-dev
      requires-private-deps: false
      dockerfile-path: dockerfile/Dockerfile.da
      build-flags: "--features debug_assertions"
      version-tag: ${{ needs.get-version.outputs.version }}

  docker-ghcr-push-sidecar:
    needs: get-version
    uses: phylaxsystems/actions/.github/workflows/release-docker-ghcr.yaml@main
    with:
      rust-binary-name: sidecar
      requires-private-deps: false
      dockerfile-path: dockerfile/Dockerfile.sidecar
      version-tag: ${{ needs.get-version.outputs.version }}

  docker-ghcr-push-shadow-driver:
    needs: get-version
    uses: phylaxsystems/actions/.github/workflows/release-docker-ghcr.yaml@main
    with:
      rust-binary-name: shadow-driver
      requires-private-deps: false
      dockerfile-path: dockerfile/Dockerfile.shadow-driver
      version-tag: ${{ needs.get-version.outputs.version }}

  docker-ghcr-push-state-worker:
    needs: get-version
    uses: phylaxsystems/actions/.github/workflows/release-docker-ghcr.yaml@main
    with:
      rust-binary-name: state-worker
      requires-private-deps: false
      dockerfile-path: dockerfile/Dockerfile.state-worker
      version-tag: ${{ needs.get-version.outputs.version }}