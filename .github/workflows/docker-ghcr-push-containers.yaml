name: Docker GHCR Push

on:
  push:
    branches: [main, reduce-image-build-cache]
  workflow_dispatch:
    inputs:
      version:
        description: "Version tag for Docker images (e.g. 1.0.3-patch). If not provided, will detect from Cargo.toml changes."
        required: false
        type: string

permissions:
  packages: write
  contents: read
  id-token: write

jobs:
  check-base-image:
    runs-on: ubuntu-latest
    outputs:
      changed: ${{ steps.check.outputs.changed }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2
      - name: Check if Dockerfile.base changed
        id: check
        run: |
          if git diff --name-only HEAD~1 HEAD | grep -q '^dockerfile/Dockerfile.base$'; then
            echo "changed=true" >> $GITHUB_OUTPUT
          else
            echo "changed=false" >> $GITHUB_OUTPUT
          fi

  build-base-image:
    needs: check-base-image
    if: needs.check-base-image.outputs.changed == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Build and push base image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: dockerfile/Dockerfile.base
          platforms: linux/amd64,linux/arm64
          push: true
          cache-from: type=registry,ref=ghcr.io/phylaxsystems/credible-sdk/credible-base:cache
          cache-to: type=registry,ref=ghcr.io/phylaxsystems/credible-sdk/credible-base:cache,mode=max
          tags: |
            ghcr.io/phylaxsystems/credible-sdk/credible-base:latest
            ghcr.io/phylaxsystems/credible-sdk/credible-base:sha-${{ github.sha }}

  get-version:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.determine-version.outputs.version }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2
      - name: Determine version tag
        id: determine-version
        run: |
          # Use manual input if provided
          if [ -n "${{ inputs.version }}" ]; then
            VERSION="${{ inputs.version }}"
            echo "Using manually specified version: $VERSION"
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Otherwise detect from Cargo.toml changes
          OLD_VERSION=$(git show HEAD~1:Cargo.toml 2>/dev/null | grep -m 1 '^version = ' | cut -d '"' -f2)                                                                                                           
          NEW_VERSION=$(grep -m 1 '^version = ' Cargo.toml | cut -d '"' -f2)                                                                                                                                               
                                                                                                                                                                                                                   
          if [ -n "$NEW_VERSION" ] && [ "$OLD_VERSION" != "$NEW_VERSION" ]; then
            VERSION="$NEW_VERSION"
            echo "Version changed from $OLD_VERSION to $NEW_VERSION"
          else
            VERSION="${{ github.sha }}"
            echo "Version unchanged, falling back to commit SHA: $VERSION"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT

  docker-ghcr-push-assertion-da:
    needs: [get-version, check-base-image, build-base-image]
    if: always() && !failure() && !cancelled()
    uses: phylaxsystems/actions/.github/workflows/release-docker-ghcr.yaml@main
    with:
      rust-binary-name: assertion-da
      requires-private-deps: false
      dockerfile-path: dockerfile/Dockerfile.da
      version-tag: ${{ needs.get-version.outputs.version }}

  docker-ghcr-push-assertion-da-dev:
    needs: [get-version, check-base-image, build-base-image]
    if: always() && !failure() && !cancelled()
    uses: phylaxsystems/actions/.github/workflows/release-docker-ghcr.yaml@main
    with:
      rust-binary-name: assertion-da-dev
      requires-private-deps: false
      dockerfile-path: dockerfile/Dockerfile.da
      build-flags: "--features debug_assertions"
      version-tag: ${{ needs.get-version.outputs.version }}

  docker-ghcr-push-sidecar:
    needs: [get-version, check-base-image, build-base-image]
    if: always() && !failure() && !cancelled()
    uses: phylaxsystems/actions/.github/workflows/release-docker-ghcr.yaml@main
    with:
      rust-binary-name: sidecar
      requires-private-deps: false
      dockerfile-path: dockerfile/Dockerfile.sidecar
      version-tag: ${{ needs.get-version.outputs.version }}

  docker-ghcr-push-sidecar-dhat:
    needs: get-version
    uses: phylaxsystems/actions/.github/workflows/release-docker-ghcr.yaml@main
    with:
      rust-binary-name: sidecar-debug
      requires-private-deps: false
      dockerfile-path: dockerfile/Dockerfile.sidecar-debug
      build-flags: "--features dhat-heap"
      version-tag: ${{ needs.get-version.outputs.version }}

  docker-ghcr-push-shadow-driver:
    needs: [get-version, check-base-image, build-base-image]
    if: always() && !failure() && !cancelled()
    uses: phylaxsystems/actions/.github/workflows/release-docker-ghcr.yaml@main
    with:
      rust-binary-name: shadow-driver
      requires-private-deps: false
      dockerfile-path: dockerfile/Dockerfile.shadow-driver
      version-tag: ${{ needs.get-version.outputs.version }}

  docker-ghcr-push-state-worker:
    needs: [get-version, check-base-image, build-base-image]
    if: always() && !failure() && !cancelled()
    uses: phylaxsystems/actions/.github/workflows/release-docker-ghcr.yaml@main
    with:
      rust-binary-name: state-worker
      requires-private-deps: false
      dockerfile-path: dockerfile/Dockerfile.state-worker
      version-tag: ${{ needs.get-version.outputs.version }}

  helm-deploy:
    if: github.ref == 'refs/heads/main'
    needs:
      - docker-ghcr-push-sidecar
      - docker-ghcr-push-state-worker
      - get-version
    strategy:
      fail-fast: false
      matrix:
        environment:
          - linea-internal
          - shadow-layer
    uses: ./.github/workflows/helm-deploy.yaml
    with:
      image-tag: ${{ needs.get-version.outputs.version }}
      environment: ${{ matrix.environment }}
    secrets: inherit

      
