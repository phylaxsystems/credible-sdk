name: Rust Test, Lint
on:
  push:
    branches: [ main ]
    paths:
      - "crates/**"
      - "Cargo.toml"
      - "Cargo.lock"
      - ".github/workflows/rust-test-lint.yml"
  pull_request:
    branches: [ main ]
    paths:
      - "crates/**"
      - "Cargo.toml"
      - "Cargo.lock"
      - "deny.toml"
      - ".github/workflows/rust-test-lint.yml"
  workflow_dispatch:
    inputs:
      debug_enabled:
        type: boolean
        description: "Run with debug logging"
        required: false
        default: false

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  # Pin nightly to a specific version for consistent caching across workflow runs
  # Update this monthly or when new Rust features are needed
  RUST_NIGHTLY_VERSION: ${{ vars.RUST_NIGHTLY_VERSION }}

jobs:
  setup:
    name: Setup Variables
    runs-on: ubuntu-latest
    outputs:
      rust-nightly: ${{ steps.vars.outputs.rust-nightly }}
    steps:
      - id: vars
        run: echo "rust-nightly=${{ env.RUST_NIGHTLY_VERSION }}" >> $GITHUB_OUTPUT

  rust-base:
    name: Rust Test & Lint
    needs: setup
    uses: phylaxsystems/actions/.github/workflows/rust-base.yaml@add-sscache-opt-rust-ci
    with:
      runner-group: "big-bois-x86"
      rust-channel: ${{ needs.setup.outputs.rust-nightly }}
      require-lockfile: true
      install-foundry: true
      dind: true
      submodules: true
      use-nextest: true
      foundry-command: "forge clean --root testdata/mock-protocol && forge build --root testdata/mock-protocol && FOUNDRY_PROFILE=assertions forge build --root testdata/mock-protocol"
      test-args: "--exclude mdbx --exclude state-worker --no-tests=warn"
      deny-checks: "advisories"
      enable-sccache: true
      feature-sets: '[
        "--no-default-features --features test",
        "--no-default-features --features test --features optimism"
        ]'

  # FIXME: State worker tests need special handling (single-threaded execution).
  # Ideally, rust-base.yaml should support a test-matrix input with clean package selection
  # (e.g., packages: ["mdbx", "state-worker"]) to avoid this duplication.
  # For now, we run these tests inline to avoid duplicate lint jobs.
  state-worker-tests:
    name: State Worker Tests (single-threaded)
    needs: setup
    runs-on:
      group: big-bois-x86
    env:
      SCCACHE_GHA_ENABLED: "true"
      RUSTC_WRAPPER: "sccache"
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - uses: dtolnay/rust-toolchain@nightly
        with:
          toolchain: ${{ needs.setup.outputs.rust-nightly }}

      - uses: mozilla-actions/sccache-action@v0.0.9

      - uses: Swatinem/rust-cache@v2
        with:
          shared-key: ${{ needs.setup.outputs.rust-nightly }}-base
          key: default

      - uses: taiki-e/install-action@nextest

      - uses: foundry-rs/foundry-toolchain@v1
        with:
          version: nightly

      - name: Build Foundry contracts
        run: forge clean --root testdata/mock-protocol && forge build --root testdata/mock-protocol && FOUNDRY_PROFILE=assertions forge build --root testdata/mock-protocol

      - name: Run state-worker tests
        run: cargo nextest run --package mdbx --package state-worker --locked --cargo-profile release --test-threads=2
